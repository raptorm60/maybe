version: '3.8'

x-db-env: &db_env
  POSTGRES_USER: ${POSTGRES_USER:-maybe_user}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-maybe_password}
  POSTGRES_DB: ${POSTGRES_DB:-maybe_production}

x-rails-env: &rails_env
  <<: *db_env
  SECRET_KEY_BASE: ${SECRET_KEY_BASE:-a7523c3d0ae56415046ad8abae168d71074a79534a7062258f8d1d51ac2f76d3c3bc86d86b6b0b307df30d9a6a90a2066a3fa9e67c5e6f374dbd7dd4e0778e13}
  SELF_HOSTED: "true"
  RAILS_FORCE_SSL: "true"  # Enforce HTTPS since we have SSL
  RAILS_ASSUME_SSL: "true" # Assume SSL for proper HTTPS handling
  DB_HOST: db
  DB_PORT: 5432
  REDIS_URL: redis://redis:6379/1
  # Finnhub API key for market data (replaces deprecated Synth)
  FINNHUB_API_KEY: ${FINNHUB_API_KEY:-d4eq5s9r01qjq397q4jgd4eq5s9r01qjq397q4k0}
  # NOTE: Enabling OpenAI will incur costs. Set spend limits on your OpenAI account before enabling.
  OPENAI_ACCESS_TOKEN: ${OPENAI_ACCESS_TOKEN}

services:
  web:
    # CHANGE THIS: Use your fork instead of official image
    # Option 1: Build from your fork locally
    # build:
    #   context: https://github.com/raptorm60/maybe.git
    #   dockerfile: Dockerfile
    # Option 2: Use pre-built image from GitHub Container Registry (after setting up GitHub Actions)
    image: ghcr.io/raptorm60/maybe:latest  # Change to your fork
    container_name: maybe-web
    volumes:
      - /home/mrbaar/maybe-finance/data/app-storage:/rails/storage
    restart: unless-stopped
    environment:
      <<: *rails_env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - maybe_net

  worker:
    # CHANGE THIS: Use your fork instead of official image
    image: ghcr.io/raptorm60/maybe:latest  # Change to your fork
    container_name: maybe-worker
    command: bundle exec sidekiq
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      <<: *rails_env
    networks:
      - maybe_net

  db:
    image: postgres:16
    container_name: maybe-db
    restart: unless-stopped
    volumes:
      - /home/mrbaar/maybe-finance/data/postgres:/var/lib/postgresql/data
    environment:
      <<: *db_env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - maybe_net

  redis:
    image: redis:latest
    container_name: maybe-redis
    restart: unless-stopped
    volumes:
      - /home/mrbaar/maybe-finance/data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - maybe_net

  nginx:
    image: nginx:stable
    container_name: nginx-reverse-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /home/mrbaar/maybe-finance/nginx/conf.d:/etc/nginx/conf.d
      - /home/mrbaar/maybe-finance/data/certbot/etc:/etc/letsencrypt
    depends_on:
      - web
    networks:
      - maybe_net
    restart: unless-stopped

  certbot-renew:
    image: certbot/certbot:latest
    container_name: certbot-renew
    volumes:
      - /home/mrbaar/maybe-finance/data/certbot/etc:/etc/letsencrypt
      - /home/mrbaar/maybe-finance/data/certbot/var:/var/lib/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - maybe_net
    restart: unless-stopped

networks:
  maybe_net:
    driver: bridge
